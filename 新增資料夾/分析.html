<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æç³»çµ±</title>
    <link rel="stylesheet" href="style.css?v=20250717">
    <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script>src="æŠ˜ç·šåœ–.js"</script>
</head>
<body>
    <div class="container">
        <!-- å·¦å´é‚Šæ¬„ -->
        <div class="sidebar">
            <h3>æœå°‹æ¬„</h3>
            
            <!-- å¹´ä»½é¸æ“‡å€åŸŸ -->
            <div class="year-selector">
                <h4>é¸æ“‡å¹´ä»½</h4>
                <div class="year-buttons">
                    <button class="year-button active" data-year="111">111</button>
                    <button class="year-button" data-year="112">112</button>
                    <button class="year-button" data-year="113">113</button>
                </div>
            </div>

            <!-- é¡¯ç¤ºæ¨¡å¼é¸æ“‡å€åŸŸ -->
            <div class="display-mode-selector">
                <h4>é¡¯ç¤ºæ¨¡å¼</h4>
                <div class="mode-buttons">
                    <button class="mode-button" data-mode="school">å­¸æ ¡</button>
                    <button class="mode-button" data-mode="department">ç³»æ‰€</button>
                    <button class="mode-button active" data-mode="group">ç³»çµ„</button>
                </div>
            </div>

            <input type="text" class="search-box" placeholder="ğŸ” æœå°‹å­¸æ ¡æˆ–ç§‘ç³»..." value="">

            <ul class="university-list" id="universityList">
                <!-- å‹•æ…‹ç”Ÿæˆçš„å­¸æ ¡ç§‘ç³»åˆ—è¡¨ -->
            </ul>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="main-content">
            <!-- é¸æ“‡çš„å­¸æ ¡é¡¯ç¤ºå€åŸŸ -->
            <div class="selected-university">
                <h3 id="selected-title">å°šæœªé¸æ“‡å­¸æ ¡</h3>
                <p id="selected-info" class="no-selection">è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡å­¸æ ¡æˆ–ç§‘ç³»</p>
            </div>

            <!-- ç¬¬ä¸€è¡Œåœ–ç‰‡ -->
            <div class="image-container medium">
                <div class="image-label">ä¸€éšé€šéç‡(è§£é‡‹)</div>
                <canvas id="chart-line-1" width="400" height="300"></canvas>
            </div>
            <div class="image-container medium">
                <div class="image-label">R-Score & åˆ†ç™¼éŒ„å–æŒ‡æ•¸(è§£é‡‹)</div>
                <canvas id="chart-line-2" width="400" height="300"></canvas>
            </div>

            <!-- ç¬¬äºŒè¡Œåœ–ç‰‡ -->
            <div class="image-container medium">
                <div class="image-label">æ­£å‚™å–æœ‰æ•ˆæ€§(è§£é‡‹)</div>
                <canvas id="chart-line-3" width="400" height="300"></canvas>
            </div>
            <div class="image-container medium">
                <div class="image-label">æ­£å–æœ‰æ•ˆæ€§(è§£é‡‹)</div>
                <canvas id="chart-line-4" width="400" height="300"></canvas>
            </div>

            <!-- ç¤¾ç¾¤ç¶²è·¯åœ– -->
            <div id=""class="image-container large">
                <span class="placeholder-text">ç¤¾ç¾¤ç¶²è·¯åœ–</span>
                <div id="network-container" style="width:100%; height:100%;"></div>
            </div>

            <!-- è¼¸å…¥å€åŸŸ -->
            <div class="input-section">
                <div class="input-label">åˆ†æçµæœ(AI)</div>
                <textarea class="input-area" placeholder="è«‹åœ¨æ­¤è¼¸å…¥åˆ†æçµæœ..."></textarea>
                <div style="text-align: right; margin-top: 10px; font-size: 12px; color: #666;">
                    INPUT
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let selectedDepartment = null;
        let selectedUniversity = null;
        let universityData = {};
        let originalUniversityData = {};
        let currentYear = '111'; // é è¨­å¹´ä»½
        let currentDisplayMode = 'group'; // é è¨­é¡¯ç¤ºæ¨¡å¼ï¼šç³»çµ„
        Chart.register(ChartDataLabels);
        // DOM å…ƒç´ 
        const searchBox = document.querySelector('.search-box');
        const universityList = document.getElementById('universityList');
        const selectedTitle = document.getElementById('selected-title');
        const selectedInfo = document.getElementById('selected-info');
        const yearButtons = document.querySelectorAll('.year-button');
        const modeButtons = document.querySelectorAll('.mode-button');

        // å¾CSVæ–‡ä»¶è®€å–è³‡æ–™
        async function loadCSVData(year = '111') {
            try {
                const response = await fetch(`${year}_data.csv`);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥ ${year} å¹´è³‡æ–™`);
                }
                const csvContent = await response.text();
                return parseCSVData(csvContent);
            } catch (error) {
                console.error(`ç„¡æ³•è®€å– ${year} å¹´CSVæª”æ¡ˆ:`, error);
                
                // å¦‚æœæ˜¯é è¨­å¹´ä»½è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å…¶ä»–å¹´ä»½
                if (year === '111') {
                    try {
                        const response = await fetch('111_data.csv');
                        const csvContent = await response.text();
                        return parseCSVData(csvContent);
                    } catch (fallbackError) {
                        alert('ç„¡æ³•è®€å–CSVæª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³');
                        return {};
                    }
                }
                return {};
            }
        }

        // è§£æCSVæ•¸æ“š
        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const schoolCode = values[0];
                const schoolName = values[1];
                const deptCode = values[2];
                const deptName = values[3];
                const category = values[4];
                
                if (!data[schoolCode]) {
                    data[schoolCode] = {
                        name: schoolName,
                        departments: {}
                    };
                }
                
                if (!data[schoolCode].departments[deptCode]) {
                    data[schoolCode].departments[deptCode] = {
                        name: deptName,
                        categories: []
                    };
                }
                
                data[schoolCode].departments[deptCode].categories.push(category);
            }
            
            return data;
        }

        // ç°¡åŒ–ç¾¤åˆ¥åç¨±
        function simplifyCategory(category) {
            const mapping = {
                '01 æ©Ÿæ¢°ç¾¤': 'æ©Ÿæ¢°',
                '02 å‹•åŠ›æ©Ÿæ¢°ç¾¤': 'å‹•æ©Ÿ',
                '03 é›»æ©Ÿèˆ‡é›»å­ç¾¤é›»æ©Ÿé¡': 'é›»æ©Ÿ',
                '04 é›»æ©Ÿèˆ‡é›»å­ç¾¤è³‡é›»é¡': 'è³‡é›»',
                '05 åŒ–å·¥ç¾¤': 'åŒ–å·¥',
                '06 åœŸæœ¨èˆ‡å»ºç¯‰ç¾¤': 'åœŸæœ¨',
                '07 è¨­è¨ˆç¾¤': 'è¨­è¨ˆ',
                '08 å·¥ç¨‹èˆ‡ç®¡ç†é¡': 'å·¥ç®¡',
                '09 å•†æ¥­èˆ‡ç®¡ç†ç¾¤': 'å•†ç®¡',
                '10 è¡›ç”Ÿèˆ‡è­·ç†é¡': 'è¡›è­·',
                '11 é£Ÿå“ç¾¤': 'é£Ÿå“',
                '12 å®¶æ”¿ç¾¤å¹¼ä¿é¡': 'å¹¼ä¿',
                '13 å®¶æ”¿ç¾¤ç”Ÿæ´»æ‡‰ç”¨é¡': 'å®¶æ”¿',
                '14 è¾²æ¥­ç¾¤': 'è¾²æ¥­',
                '15 å¤–èªç¾¤è‹±èªé¡': 'è‹±èª',
                '16 å¤–èªç¾¤æ—¥èªé¡': 'æ—¥èª',
                '17 é¤æ—…ç¾¤': 'é¤æ—…',
                '18 æµ·äº‹ç¾¤': 'æµ·äº‹',
                '19 æ°´ç”¢ç¾¤': 'æ°´ç”¢',
                '20 è—è¡“ç¾¤å½±è¦–é¡': 'å½±è¦–',
                '21 è³‡ç®¡é¡': 'è³‡ç®¡'
            };
            return mapping[category] || category;
        }

        // æ ¹æ“šé¡¯ç¤ºæ¨¡å¼ç”Ÿæˆä¸åŒçš„åˆ—è¡¨
        function generateUniversityList(data, displayMode) {
            let html = '';
            
            if (displayMode === 'school') {
                // å­¸æ ¡æ¨¡å¼ï¼šåªé¡¯ç¤ºå­¸æ ¡ï¼Œä¸å¯å±•é–‹
                Object.keys(data).forEach(schoolCode => {
                    const school = data[schoolCode];
                    html += `
                        <li class="university-group">
                            <div class="university-item" data-code="${schoolCode}" data-type="school">
                                ${schoolCode} - ${school.name}
                            </div>
                        </li>
                    `;
                });
            } else if (displayMode === 'department') {
                // ç³»æ‰€æ¨¡å¼ï¼šå­¸æ ¡å¯å±•é–‹ï¼Œé¡¯ç¤ºå»é‡è¤‡çš„ç³»æ‰€
                Object.keys(data).forEach(schoolCode => {
                    const school = data[schoolCode];
                    
                    // æ”¶é›†ä¸¦å»é‡è¤‡ç³»æ‰€
                    const uniqueDepartments = {};
                    Object.keys(school.departments).forEach(deptCode => {
                        const dept = school.departments[deptCode];
                        if (!uniqueDepartments[dept.name]) {
                            uniqueDepartments[dept.name] = {
                                codes: [deptCode],
                                name: dept.name,
                                categories: [...dept.categories]
                            };
                        } else {
                            uniqueDepartments[dept.name].codes.push(deptCode);
                            uniqueDepartments[dept.name].categories.push(...dept.categories);
                        }
                    });
                    
                    html += `
                        <li class="university-group">
                            <div class="university-header" data-code="${schoolCode}">
                                <span>${schoolCode} - ${school.name}</span>
                                <span class="dropdown-arrow">â–¼</span>
                            </div>
                            <ul class="department-list">
                    `;
                    
                    Object.keys(uniqueDepartments).forEach(deptName => {
                        const dept = uniqueDepartments[deptName];
                        html += `
                            <li class="department-item" data-codes="${dept.codes.join('|')}" data-categories="${dept.categories.join('|')}">
                                ${dept.name}
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </li>
                    `;
                });
            } else {
                // ç³»çµ„æ¨¡å¼ï¼šåŸå§‹å®Œæ•´é¡¯ç¤º
                Object.keys(data).forEach(schoolCode => {
                    const school = data[schoolCode];
                    html += `
                        <li class="university-group">
                            <div class="university-header" data-code="${schoolCode}">
                                <span>${schoolCode} - ${school.name}</span>
                                <span class="dropdown-arrow">â–¼</span>
                            </div>
                            <ul class="department-list">
                    `;
                    
                    Object.keys(school.departments).forEach(deptCode => {
                        const dept = school.departments[deptCode];
                        const simplifiedCategories = dept.categories.map(simplifyCategory);
                        const categoryText = simplifiedCategories.join(', ');
                        
                        html += `
                            <li class="department-item" data-code="${deptCode}" data-categories="${dept.categories.join('|')}">
                                ${deptCode} - [${categoryText}] ${dept.name}
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </li>
                    `;
                });
            }
            
            return html;
        }

        // åˆ‡æ›é¡¯ç¤ºæ¨¡å¼
        function switchDisplayMode(mode) {
            if (currentDisplayMode === mode) {
                return;
            }
            
            currentDisplayMode = mode;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            modeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-mode') === mode) {
                    btn.classList.add('active');
                }
            });
            
            // é‡æ–°ç”Ÿæˆåˆ—è¡¨
            const html = generateUniversityList(universityData, currentDisplayMode);
            universityList.innerHTML = html;
            
            // é‡æ–°åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
            initializeEventListeners();
            
            // æ¸…ç©ºæœå°‹æ¡†
            searchBox.value = '';
            
            // é‡ç½®é¸æ“‡ç‹€æ…‹
            resetSelection();
            
            console.log(`åˆ‡æ›åˆ°${mode}æ¨¡å¼`);
        }

        // åˆ‡æ›å¹´ä»½åŠŸèƒ½
        async function switchYear(year) {
            // å¦‚æœå·²ç¶“æ˜¯ç•¶å‰å¹´ä»½ï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥
            if (currentYear === year) {
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            universityList.innerHTML = '<li style="padding: 10px; color: #666; text-align: center;">è¼‰å…¥ä¸­...</li>';
            
            try {
                // è¼‰å…¥æ–°å¹´ä»½çš„è³‡æ–™
                const newData = await loadCSVData(year);
                
                if (Object.keys(newData).length === 0) {
                    // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä½†ä¸æ”¹è®Šå¹´ä»½
                    universityList.innerHTML = `<li style="padding: 10px; color: #ff6b6b; text-align: center;">ç„¡æ³•è¼‰å…¥ ${year} å¹´è³‡æ–™</li>`;
                    return;
                }
                
                // æ›´æ–°å…¨å±€è®Šé‡
                currentYear = year;
                universityData = newData;
                originalUniversityData = JSON.parse(JSON.stringify(newData));
                
                // æ›´æ–°å¹´ä»½æŒ‰éˆ•ç‹€æ…‹
                yearButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-year') === year) {
                        btn.classList.add('active');
                    }
                });
                
                // é‡æ–°ç”Ÿæˆåˆ—è¡¨
                const html = generateUniversityList(universityData, currentDisplayMode);
                universityList.innerHTML = html;
                
                // é‡æ–°åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
                initializeEventListeners();
                
                // æ¸…ç©ºæœå°‹æ¡†
                searchBox.value = '';
                
                // é‡ç½®é¸æ“‡ç‹€æ…‹
                resetSelection();
                
                console.log(`æˆåŠŸåˆ‡æ›åˆ° ${year} å¹´è³‡æ–™ï¼Œå…±è¼‰å…¥`, Object.keys(universityData).length, 'æ‰€å­¸æ ¡');
                
            } catch (error) {
                console.error('åˆ‡æ›å¹´ä»½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                universityList.innerHTML = `<li style="padding: 10px; color: #ff6b6b; text-align: center;">è¼‰å…¥ ${year} å¹´è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤</li>`;
            }
        }

        // é‡ç½®é¸æ“‡ç‹€æ…‹
        function resetSelection() {
            selectedDepartment = null;
            selectedUniversity = null;
            selectedTitle.textContent = 'å°šæœªé¸æ“‡å­¸æ ¡';
            selectedInfo.textContent = 'è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡å­¸æ ¡æˆ–ç§‘ç³»';
            selectedInfo.classList.add('no-selection');
        }

        // åˆå§‹åŒ–å¹´ä»½æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        function initializeYearButtons() {
            yearButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const year = this.getAttribute('data-year');
                    switchYear(year);
                });
            });
        }

        // åˆå§‹åŒ–é¡¯ç¤ºæ¨¡å¼æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        function initializeModeButtons() {
            modeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    switchDisplayMode(mode);
                });
            });
        }

        // åˆå§‹åŒ–æ•¸æ“šå’ŒUI
        async function initializeData() {
            try {
                universityData = await loadCSVData(currentYear);
                originalUniversityData = JSON.parse(JSON.stringify(universityData)); // æ·±æ‹·è²
                
                if (Object.keys(universityData).length === 0) {
                    universityList.innerHTML = '<li style="padding: 10px; color: #666;">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèªCSVæª”æ¡ˆå·²ä¸Šå‚³</li>';
                    return;
                }
                
                const html = generateUniversityList(universityData, currentDisplayMode);
                universityList.innerHTML = html;
                
                initializeEventListeners();
                
                console.log('è³‡æ–™è¼‰å…¥å®Œæˆï¼Œå…±è¼‰å…¥', Object.keys(universityData).length, 'æ‰€å­¸æ ¡');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                universityList.innerHTML = '<li style="padding: 10px; color: #ff6b6b;">è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤</li>';
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        function initializeEventListeners() {
            if (currentDisplayMode === 'school') {
                // å­¸æ ¡æ¨¡å¼ï¼šç›´æ¥é»æ“Šå­¸æ ¡é …ç›®
                document.querySelectorAll('.university-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
                        document.querySelectorAll('.university-item').forEach(i => i.classList.remove('selected'));
                        
                        // æ·»åŠ é¸ä¸­ç‹€æ…‹
                        this.classList.add('selected');
                        
                        // æ›´æ–°é¸ä¸­ä¿¡æ¯
                        updateSelectedSchool(this);
                    });
                });
            } else {
                // ç³»æ‰€å’Œç³»çµ„æ¨¡å¼ï¼šå­¸æ ¡æ¨™é¡Œé»æ“Šäº‹ä»¶
                document.querySelectorAll('.university-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const departmentList = this.nextElementSibling;
                        const isActive = this.classList.contains('active');
                        
                        // é—œé–‰æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰é¸å–®
                        document.querySelectorAll('.university-header').forEach(h => h.classList.remove('active'));
                        document.querySelectorAll('.department-list').forEach(dl => dl.classList.remove('active'));
                        
                        // åˆ‡æ›ç•¶å‰é¸å–®
                        if (!isActive) {
                            this.classList.add('active');
                            departmentList.classList.add('active');
                        }
                    });
                });

                // ç§‘ç³»é …ç›®é»æ“Šäº‹ä»¶
                document.querySelectorAll('.department-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
                        document.querySelectorAll('.department-item').forEach(i => i.classList.remove('selected'));
                        
                        // æ·»åŠ é¸ä¸­ç‹€æ…‹
                        this.classList.add('selected');
                        
                        // æ›´æ–°é¸ä¸­ä¿¡æ¯
                        updateSelectedDepartment(this);
                    });
                });
            }

            // æœå°‹åŠŸèƒ½
            searchBox.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                searchUniversitiesAndDepartments(searchTerm);
            });
        }
        
        // æ›´æ–°é¸ä¸­å­¸æ ¡é¡¯ç¤ºï¼ˆå­¸æ ¡æ¨¡å¼ï¼‰
        function updateSelectedSchool(schoolElement) {
            const schoolCode = schoolElement.getAttribute('data-code');
            const school = universityData[schoolCode];
            
            selectedTitle.textContent = school.name;
            selectedInfo.innerHTML = `
                å­¸æ ¡ä»£ç¢¼: ${schoolCode} | å¹´ä»½: ${currentYear}<br>
                æ¨¡å¼: å­¸æ ¡æ¨¡å¼
            `;
            selectedInfo.classList.remove('no-selection');
            
            selectedUniversity = {
                year: currentYear,
                universityCode: schoolCode,
                universityName: school.name,
                mode: 'school',
                fullText: `${school.name} (${currentYear}å¹´)`
            };
            
            console.log('é¸ä¸­å­¸æ ¡:', selectedUniversity);
        }

        // æ›´æ–°é¸ä¸­ç§‘ç³»é¡¯ç¤º
        function updateSelectedDepartment(departmentElement) {
            const universityHeader = departmentElement.closest('.university-group').querySelector('.university-header');
            const schoolCode = universityHeader.getAttribute('data-code');
            const school = universityData[schoolCode];
            
            let departmentInfo = {};
            
            if (currentDisplayMode === 'department') {
                // ç³»æ‰€æ¨¡å¼
                const deptCodes = departmentElement.getAttribute('data-codes').split('|');
                const categories = departmentElement.getAttribute('data-categories').split('|');
                const deptName = departmentElement.textContent.trim();
                
                departmentInfo = {
                    year: currentYear,
                    universityCode: schoolCode,
                    universityName: school.name,
                    departmentCodes: deptCodes,
                    departmentName: deptName,
                    categories: categories,
                    mode: 'department',
                    fullText: `${school.name} - ${deptName} (${currentYear}å¹´)`
                };
                
                selectedTitle.textContent = `${school.name} - ${deptName}`;
                selectedInfo.innerHTML = `
                    å­¸æ ¡ä»£ç¢¼: ${schoolCode} | ç§‘ç³»ä»£ç¢¼: ${deptCodes.join(', ')} | å¹´ä»½: ${currentYear}<br>
                    æ¨¡å¼: ç³»æ‰€æ¨¡å¼ | æ‹›ç”Ÿç¾¤åˆ¥: ${categories.join(', ')}
                `;
            } else {
                // ç³»çµ„æ¨¡å¼
                const deptCode = departmentElement.getAttribute('data-code');
                const categories = departmentElement.getAttribute('data-categories').split('|');
                const dept = school.departments[deptCode];
                
                departmentInfo = {
                    year: currentYear,
                    universityCode: schoolCode,
                    universityName: school.name,
                    departmentCode: deptCode,
                    departmentName: dept.name,
                    categories: categories,
                    mode: 'group',
                    fullText: `${school.name} - ${dept.name} (${currentYear}å¹´)`
                };
                    const code = deptCode;

    // æª”åç‚º nodes_ä»£ç¢¼.json èˆ‡ edges_ä»£ç¢¼.json
                    const nodeFile = `node_${code}_${currentYear}.json`;
                    const edgeFile = `edge_${code}_${currentYear}.json`;
                    fetch(`data_${code}_${currentYear}.json`)
                        .then(res => res.json())
                        .then(data => {
                                drawLineChart("chart-line-1", data, "ä¸€éšé€šéç‡", "ä¸€éšé€šéç‡");
                                drawDualAxisLineChart("chart-line-2", data, "Rå€¼", "ç™»åˆ†å¹³å‡åˆ†æ•¸");
                                drawLineChart("chart-line-3", data, "æ­£å‚™å–æœ‰æ•ˆæ€§", "æ­£å‚™å–æœ‰æ•ˆæ€§");
                                drawLineChart("chart-line-4", data, "æ­£å–æœ‰æ•ˆæ€§", "æ­£å–æœ‰æ•ˆæ€§");
                        });
    // è¼‰å…¥ä¸¦ç¹ªè£½ network
                Promise.all([
                    fetch(nodeFile).then(res => res.json()),
                    fetch(edgeFile).then(res => res.json())
                ])
                .then(([nodes, edges]) => {
                    renderNetwork(nodes, edges);
                    })
                .catch(err => {
                    console.error(`è¼‰å…¥ ${nodeFile} æˆ– ${edgeFile} å¤±æ•—:`, err);
                    });
                
                selectedTitle.textContent = `${school.name} - ${dept.name}`;
                selectedInfo.innerHTML = `
                    å­¸æ ¡ä»£ç¢¼: ${schoolCode} | ç§‘ç³»ä»£ç¢¼: ${deptCode} | å¹´ä»½: ${currentYear}<br>
                    æ¨¡å¼: ç³»çµ„æ¨¡å¼ | æ‹›ç”Ÿç¾¤åˆ¥: ${categories.join(', ')}
                `;
            }
            
            selectedInfo.classList.remove('no-selection');
            selectedDepartment = departmentInfo;
            
            console.log('é¸ä¸­ç§‘ç³»:', selectedDepartment);
        }
        
        // æœå°‹åŠŸèƒ½
        function searchUniversitiesAndDepartments(searchTerm) {
            if (currentDisplayMode === 'school') {
                // å­¸æ ¡æ¨¡å¼æœå°‹
                const universityItems = document.querySelectorAll('.university-item');
                universityItems.forEach(item => {
                    const itemText = item.textContent.toLowerCase();
                    if (itemText.includes(searchTerm) || searchTerm === '') {
                        item.parentElement.style.display = 'block';
                    } else {
                        item.parentElement.style.display = 'none';
                    }
                });
            } else {
                // ç³»æ‰€å’Œç³»çµ„æ¨¡å¼æœå°‹
                const universityGroups = document.querySelectorAll('.university-group');
                
                universityGroups.forEach(group => {
                    const header = group.querySelector('.university-header');
                    const departmentList = group.querySelector('.department-list');
                    const departments = group.querySelectorAll('.department-item');
                    
                    const universityText = header.textContent.toLowerCase();
                    let hasVisibleDepartments = false;
                    
                    // æª¢æŸ¥ç§‘ç³»æ˜¯å¦åŒ¹é…
                    departments.forEach(dept => {
                        const deptText = dept.textContent.toLowerCase();
                        if (deptText.includes(searchTerm) || searchTerm === '') {
                            dept.style.display = 'block';
                            hasVisibleDepartments = true;
                        } else {
                            dept.style.display = 'none';
                        }
                    });
                    
                    // æª¢æŸ¥å­¸æ ¡æ˜¯å¦åŒ¹é…æˆ–æœ‰å¯è¦‹ç§‘ç³»
                    if (universityText.includes(searchTerm) || hasVisibleDepartments || searchTerm === '') {
                        group.style.display = 'block';
                        
                        // å¦‚æœæ˜¯æœå°‹çµæœï¼Œè‡ªå‹•å±•é–‹
                        if (searchTerm && (universityText.includes(searchTerm) || hasVisibleDepartments)) {
                            header.classList.add('active');
                            departmentList.classList.add('active');
                        }
                    } else {
                        group.style.display = 'none';
                    }
                    
                    // å¦‚æœå­¸æ ¡åŒ¹é…ä½†æ²’æœ‰ç§‘ç³»åŒ¹é…ï¼Œé¡¯ç¤ºæ‰€æœ‰ç§‘ç³»
                    if (universityText.includes(searchTerm) && searchTerm !== '') {
                        departments.forEach(dept => {
                            dept.style.display = 'block';
                        });
                    }
                });
                
                // æ¸…ç©ºæœå°‹æ™‚æ¢å¾©æ‰€æœ‰é …ç›®
                if (searchTerm === '') {
                    universityGroups.forEach(group => {
                        group.style.display = 'block';
                        const header = group.querySelector('.university-header');
                        const departmentList = group.querySelector('.department-list');
                        const departments = group.querySelectorAll('.department-item');
                        
                        header.classList.remove('active');
                        departmentList.classList.remove('active');
                        departments.forEach(dept => {
                            dept.style.display = 'block';
                        });
                    });
                }
            }
        }

        // åœ–ç‰‡å®¹å™¨é»æ“Šäº‹ä»¶
        function initializeImageContainers() {
            const imageContainers = document.querySelectorAll('.image-container');
            imageContainers.forEach(container => {
                container.addEventListener('mouseenter', function() {
                    this.style.cursor = 'pointer';
                });
                
                container.addEventListener('click', function() {
                    const label = this.querySelector('.image-label')?.textContent || 'ç¤¾ç¾¤ç¶²è·¯åœ–';
                    if (selectedDepartment || selectedUniversity) {
                        const selected = selectedDepartment || selectedUniversity;
                        console.log(`${selected.fullText} - ${label}`);
                        console.log('é¸ä¸­çš„è©³ç´°è³‡è¨Š:', selected);
                    } else {
                        console.log(`è«‹å…ˆé¸æ“‡å­¸æ ¡æˆ–ç§‘ç³» - ${label}`);
                    }
                });
            });
        }

        // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            initializeYearButtons(); // åˆå§‹åŒ–å¹´ä»½æŒ‰éˆ•
            initializeModeButtons(); // åˆå§‹åŒ–æ¨¡å¼æŒ‰éˆ•
            initializeData();
            initializeImageContainers();
        });

        // å°å‡ºå‡½æ•¸ä¾›å¤–éƒ¨ä½¿ç”¨
        window.getSelectedDepartment = function() {
            return selectedDepartment;
        };
        
        window.getSelectedUniversity = function() {
            return selectedUniversity;
        };
        
        window.getUniversityData = function() {
            return universityData;
        };
        
        window.getCurrentYear = function() {
            return currentYear;
        };
        
        window.getCurrentDisplayMode = function() {
            return currentDisplayMode;
        };
        
        // æ–°å¢ï¼šå–å¾—åŸå§‹CSVè³‡æ–™çš„å‡½æ•¸
        window.getOriginalCSVData = function() {
            return originalUniversityData;
        };
        
        // æ–°å¢ï¼šé‡æ–°è¼‰å…¥CSVè³‡æ–™çš„å‡½æ•¸
        window.reloadCSVData = async function() {
            await initializeData();
        };
        
        // æ–°å¢ï¼šæ‰‹å‹•åˆ‡æ›å¹´ä»½çš„å‡½æ•¸
        window.switchToYear = function(year) {
            return switchYear(year);
        };
        
        // æ–°å¢ï¼šæ‰‹å‹•åˆ‡æ›é¡¯ç¤ºæ¨¡å¼çš„å‡½æ•¸
        window.switchToDisplayMode = function(mode) {
            return switchDisplayMode(mode);
        };
        async function loadNetworkFromFiles() {
            try {
            const [nodesRes, edgesRes] = await Promise.all([
                fetch(`./node_${deptCode}_${year}.json`),
                fetch(`./edge_${deptCode}_${year}.json`)
                ]);
               
            const nodesData = await nodesRes.json();
            const edgesData = await edgesRes.json();

            renderNetwork(nodesData, edgesData);
            } catch (error) {
                console.error("è¼‰å…¥ç¶²è·¯åœ–å¤±æ•—", error);
                }
        }
        function renderNetwork(nodes, edges) {
             const placeholder = document.querySelector('.placeholder-text');
             if (placeholder) placeholder.style.display = 'block';

            cytoscape({
            container: document.getElementById('network-container'),
            elements: [
                ...nodes.map(n => ({ data: { id: n.id, label: n.label } })),
                ...edges.map(e => ({ data: { source: e.source, target: e.target } }))
                
            ],
            
            layout: {
                        name: 'cose',
                        idealEdgeLength: 160,     // é©ä¸­é‚Šé•·ï¼Œé¿å…ç¯€é»æ“ åœ¨ä¸€èµ·
                        nodeRepulsion: 800000,    // é«˜æ’æ–¥åŠ›ï¼Œç¯€é»æœƒåˆ†å¾—é–‹
                        gravity: 50,              // æ¸›ä½é‡åŠ›ï¼Œé¿å…å‘ä¸­å¿ƒé›†ä¸­
                        numIter: 1500,            // å¤šè·‘ä¸€äº›è¿­ä»£è®“åœ–æ›´ç©©å®š
                        initialTemp: 200,         // åˆå§‹é‹å‹•èƒ½é‡
                        coolingFactor: 0.95,      // å†·å»é€Ÿåº¦
                        animate: true,
                        fit: true,                // è‡ªå‹•ç¸®æ”¾é©æ‡‰ç•«å¸ƒ
                        padding: 30      
                },
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'background-color': '#667eea',
                        'color': '#000000',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': '12px',
                        'width': 40,
                        'height': 40,
                        'text-wrap': 'wrap',
                        'text-max-width': 100
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#ccc',
                        'curve-style': 'bezier'
                    }
                }
            ]
        });
            console.log('ç¤¾ç¾¤ç¶²è·¯åœ–å·²æ¸²æŸ“');
        };
        const chartInstances = {};

// å®‰å…¨ç•«åœ–ï¼šå…ˆ destroy å† new
        function safeDraw(containerId, chartConfig) {
        if (chartInstances[containerId]) {
            chartInstances[containerId].destroy();
        }
        const ctx = document.getElementById(containerId);
        chartInstances[containerId] = new Chart(ctx, chartConfig);
        }
        function drawLineChart(containerId, data, labelName="", dataKey="") {
            const labels = data.map(d => d["111å¹´è™ç§‘è³‡ç®¡(è³‡é›»é¡)"].split('/')[1]);
            const values = data.map(d => d[dataKey]);

            safeDraw(containerId, {
                type: 'line',
                data: {
                labels: labels,
                datasets: [{
                    label: labelName,
                    data: values,
                    borderColor: "#3e95cd",
                    fill: false,
                    tension: 0.4
                }]
                },
                options: {
                responsive: true,
                 plugins: {
                    datalabels: {
                         color: '#000',
                        align: 'top',
                        formatter: function(value) {
                            return value.toFixed(2); // å°æ•¸é»å…©ä½
          },
          font: {size: 10}
        },
        title: { display: true, text: labelName }
      }
    },
     
                
            });
        }
        function drawDualAxisLineChart(containerId, data, rKey="", avgKey="") {
            const labels = data.map(d => d["111å¹´è™ç§‘è³‡ç®¡(è³‡é›»é¡)"].split('/')[1]);
            const rValues = data.map(d => d[rKey]);
            const avgValues = data.map(d => d[avgKey]);

            safeDraw(containerId, {
                type: 'line',
                data: {
                labels: labels,
                datasets: [
                    {
                    label: rKey,
                    data: rValues,
                    borderColor: "#3e95cd",
                    yAxisID: 'y1',
                    fill: false,
                    tension: 0.4
                    },
                    {
                    label: avgKey,
                    data: avgValues,
                    borderColor: "#ff9800",
                    yAxisID: 'y2',
                    fill: false,
                    tension: 0.4
                    }
                ]
                },
                options: {
                responsive: true,
                plugins: {
                    title: {
                    display: true,
                    text: `${rKey} & ${avgKey}`
                    },
                    datalabels: {
                         color: '#000',
                        align: 'top',
                        formatter: function(value) {
                            return value.toFixed(2); // å°æ•¸é»å…©ä½
                        },
                        font: {size: 10}
                    },
                },
                scales: {
                    y1: {
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 100,
                    display: true,
                    title: { display: true, text: rKey }
                    },
                    y2: {
                    type: 'linear',
                    position: 'right',
                    min: 0,
                    max: 100,
                    display: true,
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: avgKey }
                    }
                }
                }
            });
        }

    </script>
</body>
</html>